name: ðŸš€ Automated Deployment

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.1'
  IOS_VERSION: '17.2'

jobs:
  # ==========================================
  # ðŸ” PRE-DEPLOYMENT VALIDATION
  # ==========================================
  pre-deployment:
    name: ðŸ” Pre-Deployment Validation
    runs-on: macos-14
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ” Validate Branch
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "âœ… Valid branch/tag for deployment"
        else
          echo "âŒ Invalid branch for deployment"
          exit 1
        fi
    
    - name: ðŸ“‹ Extract Version Info
      id: version
      run: |
        # Extrair versÃ£o do Info.plist
        VERSION=$(plutil -extract CFBundleShortVersionString raw ManusPsiqueia/Info.plist)
        BUILD=$(plutil -extract CFBundleVersion raw ManusPsiqueia/Info.plist)
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD" >> $GITHUB_OUTPUT
        echo "ðŸ“± App Version: $VERSION ($BUILD)"
    
    - name: âœ… Validation Result
      id: validation
      run: |
        if [ "${{ inputs.skip_tests }}" == "true" ]; then
          echo "âš ï¸ Skipping tests as requested"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "ðŸ§ª Tests will be required before deployment"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  # ==========================================
  # ðŸ§ª DEPLOYMENT TESTS
  # ==========================================
  deployment-tests:
    name: ðŸ§ª Deployment Tests
    runs-on: macos-14
    needs: pre-deployment
    if: needs.pre-deployment.outputs.should_deploy == 'false'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸŽ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-deployment-${{ hashFiles('**/*.xcodeproj', '**/Package.swift') }}
    
    - name: ðŸ”§ Resolve Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia
    
    - name: ðŸ§ª Run Critical Tests
      run: |
        xcodebuild test \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=${{ env.IOS_VERSION }}' \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO \
          -enableCodeCoverage YES \
          | xcpretty --color
    
    - name: ðŸ”’ Security Validation
      run: |
        echo "ðŸ” Running security checks..."
        
        # Verificar se nÃ£o hÃ¡ chaves hardcoded
        if grep -r "sk_live\|pk_live\|sk_test\|pk_test" ManusPsiqueia/ --exclude-dir=.git; then
          echo "âŒ Found potential API keys in code"
          exit 1
        fi
        
        # Verificar configuraÃ§Ãµes de seguranÃ§a
        if ! grep -q "NSAppTransportSecurity" ManusPsiqueia/Info.plist; then
          echo "âš ï¸ App Transport Security not configured"
        fi
        
        echo "âœ… Security validation passed"

  # ==========================================
  # ðŸ—ï¸ BUILD FOR DISTRIBUTION
  # ==========================================
  build-distribution:
    name: ðŸ—ï¸ Build for Distribution
    runs-on: macos-14
    needs: [pre-deployment, deployment-tests]
    if: always() && (needs.pre-deployment.outputs.should_deploy == 'true' || needs.deployment-tests.result == 'success')
    
    strategy:
      matrix:
        configuration: [Release]
        destination: ['generic/platform=iOS']
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸŽ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: ðŸ“¦ Restore Cache
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-deployment-${{ hashFiles('**/*.xcodeproj', '**/Package.swift') }}
    
    - name: ðŸ”§ Configure Build Settings
      run: |
        # Configurar nÃºmero de build baseado no timestamp
        BUILD_NUMBER=$(date +%Y%m%d%H%M)
        plutil -replace CFBundleVersion -string "$BUILD_NUMBER" ManusPsiqueia/Info.plist
        echo "ðŸ“± Build Number: $BUILD_NUMBER"
    
    - name: ðŸ—ï¸ Build Archive
      run: |
        xcodebuild archive \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination '${{ matrix.destination }}' \
          -configuration ${{ matrix.configuration }} \
          -archivePath ManusPsiqueia.xcarchive \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty --color
    
    - name: ðŸ“¦ Create IPA (Simulation)
      run: |
        # Simular criaÃ§Ã£o de IPA (sem certificados reais)
        echo "ðŸ“¦ Creating distribution package..."
        mkdir -p dist
        
        # Copiar arquivos importantes para distribuiÃ§Ã£o
        cp -r ManusPsiqueia.xcarchive dist/
        
        # Criar manifesto de build
        cat > dist/build-manifest.json << EOF
        {
          "version": "${{ needs.pre-deployment.outputs.version }}",
          "build": "$(date +%Y%m%d%H%M)",
          "configuration": "${{ matrix.configuration }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}"
        }
        EOF
        
        echo "âœ… Distribution package created"
    
    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: distribution-${{ matrix.configuration }}
        path: |
          dist/
          ManusPsiqueia.xcarchive
        retention-days: 30

  # ==========================================
  # ðŸš€ DEPLOY TO STAGING
  # ==========================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: macos-14
    needs: [pre-deployment, build-distribution]
    if: github.ref == 'refs/heads/master' || inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: ðŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: distribution-Release
        path: dist/
    
    - name: ðŸš€ Deploy to TestFlight (Simulation)
      run: |
        echo "ðŸš€ Deploying to TestFlight..."
        echo "ðŸ“± Version: ${{ needs.pre-deployment.outputs.version }}"
        echo "ðŸ—ï¸ Build: $(cat dist/build-manifest.json | grep build | cut -d'"' -f4)"
        
        # Simular upload para TestFlight
        echo "âœ… Successfully uploaded to TestFlight (Internal Testing)"
        
        # Simular notificaÃ§Ã£o para testadores
        echo "ðŸ“§ Notifying internal testers..."
        echo "âœ… Internal testers notified"
    
    - name: ðŸ“Š Update Deployment Status
      run: |
        echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** $(cat dist/build-manifest.json | grep build | cut -d'"' -f4)" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Staging (TestFlight Internal)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # ðŸ­ DEPLOY TO PRODUCTION
  # ==========================================
  deploy-production:
    name: ðŸ­ Deploy to Production
    runs-on: macos-14
    needs: [pre-deployment, build-distribution]
    if: startsWith(github.ref, 'refs/tags/v') || inputs.environment == 'production'
    environment: production
    
    steps:
    - name: ðŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: distribution-Release
        path: dist/
    
    - name: ðŸ” Production Validation
      run: |
        echo "ðŸ” Running production validation..."
        
        # Verificar se Ã© uma tag de versÃ£o vÃ¡lida
        if [[ "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âœ… Valid version tag"
        elif [ "${{ inputs.environment }}" == "production" ]; then
          echo "âš ï¸ Manual production deployment"
        else
          echo "âŒ Invalid version tag for production"
          exit 1
        fi
    
    - name: ðŸ­ Deploy to App Store (Simulation)
      run: |
        echo "ðŸ­ Deploying to App Store..."
        echo "ðŸ“± Version: ${{ needs.pre-deployment.outputs.version }}"
        echo "ðŸ—ï¸ Build: $(cat dist/build-manifest.json | grep build | cut -d'"' -f4)"
        
        # Simular upload para App Store
        echo "âœ… Successfully uploaded to App Store Connect"
        
        # Simular submissÃ£o para revisÃ£o
        echo "ðŸ“‹ Submitting for App Store Review..."
        echo "âœ… Submitted for review"
    
    - name: ðŸŽ‰ Production Deployment Complete
      run: |
        echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** $(cat dist/build-manifest.json | grep build | cut -d'"' -f4)" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production (App Store)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Submitted for Review" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor App Store Connect for review status" >> $GITHUB_STEP_SUMMARY
        echo "- Prepare release notes for users" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor crash reports and user feedback" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # ðŸ“Š DEPLOYMENT SUMMARY
  # ==========================================
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch/Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "âœ… **Staging:** Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-staging.result }}" == "skipped" ]; then
          echo "â­ï¸ **Staging:** Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Staging:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "âœ… **Production:** Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-production.result }}" == "skipped" ]; then
          echo "â­ï¸ **Production:** Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Production:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
