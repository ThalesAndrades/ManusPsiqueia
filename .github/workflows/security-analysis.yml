---
name: ğŸ” Security Analysis

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: ğŸ” CodeQL Analysis
    runs-on: macos-14
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.1'
      
      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: ğŸ—ï¸ Build for Analysis
        run: |
          xcodebuild clean build \
            -project ManusPsiqueia.xcodeproj \
            -scheme ManusPsiqueia \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO
      
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  dependency-check:
    name: ğŸ“¦ Dependency Check
    runs-on: macos-14
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Analyze Dependencies
        run: |
          echo "ğŸ“¦ Analyzing project dependencies..."
          
          # Check Package.swift if exists
          if [ -f "Package.swift" ]; then
            echo "ğŸ“‹ Found Package.swift"
            swift package show-dependencies || echo "No dependencies or error reading Package.swift"
          fi
          
          # Check for common vulnerable patterns
          echo "ğŸ” Checking for security patterns..."
          if find . -name "*.swift" -exec grep -l "http://" {} \; | grep -v localhost; then
            echo "âš ï¸ Found insecure HTTP URLs"
          fi
          
          echo "âœ… Dependency check completed"

  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: macos-14
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ›¡ï¸ Run Security Audit
        run: |
          echo "ğŸ›¡ï¸ Running security audit..."
          
          # Healthcare-specific checks
          echo "ğŸ¥ Healthcare security checks..."
          if grep -r "patient\|medical\|health" . --include="*.swift" -i; then
            echo "âœ… Healthcare-related code found - ensure HIPAA compliance"
          fi
          
          # Check for encryption usage
          if grep -r "AES\|CryptoKit\|CommonCrypto" . --include="*.swift"; then
            echo "âœ… Encryption libraries detected"
          else
            echo "âš ï¸ No encryption libraries detected"
          fi
          
          # Check for keychain usage
          if grep -r "Keychain\|kSecClass" . --include="*.swift"; then
            echo "âœ… Keychain usage detected"
          else
            echo "âš ï¸ No keychain usage detected"
          fi
          
          echo "ğŸ›¡ï¸ Security audit completed"