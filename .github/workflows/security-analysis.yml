---
name: 🔍 Security Analysis

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: 🔍 CodeQL Analysis
    runs-on: macos-14
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 🍎 Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.1'
      
      - name: 🔍 Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: 🏗️ Build for Analysis
        run: |
          xcodebuild clean build \
            -project ManusPsiqueia.xcodeproj \
            -scheme ManusPsiqueia \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO
      
      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  dependency-check:
    name: 📦 Dependency Check
    runs-on: macos-14
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 📦 Analyze Dependencies
        run: |
          echo "📦 Analyzing project dependencies..."
          
          # Check Package.swift if exists
          if [ -f "Package.swift" ]; then
            echo "📋 Found Package.swift"
            swift package show-dependencies || echo "No dependencies or error reading Package.swift"
          fi
          
          # Check for common vulnerable patterns
          echo "🔍 Checking for security patterns..."
          if find . -name "*.swift" -exec grep -l "http://" {} \; | grep -v localhost; then
            echo "⚠️ Found insecure HTTP URLs"
          fi
          
          echo "✅ Dependency check completed"

  security-audit:
    name: 🛡️ Security Audit
    runs-on: macos-14
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 🛡️ Run Security Audit
        run: |
          echo "🛡️ Running security audit..."
          
          # Healthcare-specific checks
          echo "🏥 Healthcare security checks..."
          if grep -r "patient\|medical\|health" . --include="*.swift" -i; then
            echo "✅ Healthcare-related code found - ensure HIPAA compliance"
          fi
          
          # Check for encryption usage
          if grep -r "AES\|CryptoKit\|CommonCrypto" . --include="*.swift"; then
            echo "✅ Encryption libraries detected"
          else
            echo "⚠️ No encryption libraries detected"
          fi
          
          # Check for keychain usage
          if grep -r "Keychain\|kSecClass" . --include="*.swift"; then
            echo "✅ Keychain usage detected"
          else
            echo "⚠️ No keychain usage detected"
          fi
          
          echo "🛡️ Security audit completed"