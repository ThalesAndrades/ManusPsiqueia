name: üçé iOS CI/CD Pipeline - ManusPsiqueia

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'
  IOS_SIMULATOR: 'iPhone 15 Pro'
  IOS_VERSION: '17.2'

jobs:
  # ==========================================
  # üîç CODE QUALITY & SECURITY ANALYSIS
  # ==========================================
  code-quality:
    name: üîç Code Quality Analysis
    runs-on: macos-14
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üì¶ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.xcodeproj', '**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-xcode-
    
    - name: üîß Install SwiftLint
      run: |
        brew install swiftlint
        swiftlint version
    
    - name: üîç Run SwiftLint Analysis
      run: |
        swiftlint lint --reporter github-actions-logging
        swiftlint lint --reporter json > swiftlint-results.json
      continue-on-error: true
    
    - name: üìä Upload SwiftLint Results
      uses: actions/upload-artifact@v3
      with:
        name: swiftlint-results
        path: swiftlint-results.json
    
    - name: üîí Run Security Analysis
      run: |
        # Verificar chaves hardcoded
        grep -r "sk_live\|pk_live\|sk_test\|pk_test" . --exclude-dir=.git || echo "‚úÖ No hardcoded keys found"
        
        # Verificar URLs inseguras
        grep -r "http://" . --exclude-dir=.git --exclude="*.md" || echo "‚úÖ No insecure URLs found"
        
        # Verificar dados sens√≠veis
        grep -r "password\|secret\|token" . --exclude-dir=.git --exclude="*.md" || echo "‚úÖ No sensitive data patterns found"

  # ==========================================
  # üß™ BUILD & TEST
  # ==========================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: macos-14
    needs: code-quality
    
    strategy:
      matrix:
        scheme: [ManusPsiqueia]
        destination: 
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
          - 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation),OS=17.2'
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üì¶ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.xcodeproj', '**/*.swift') }}
    
    - name: üîß Resolve Dependencies
      run: |
        xcodebuild -resolvePackageDependencies -project ManusPsiqueia.xcodeproj -scheme ${{ matrix.scheme }}
    
    - name: üèóÔ∏è Build Project
      run: |
        xcodebuild clean build \
          -project ManusPsiqueia.xcodeproj \
          -scheme ${{ matrix.scheme }} \
          -destination '${{ matrix.destination }}' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty --color --report html --output build-report.html
    
    - name: üß™ Run Unit Tests
      run: |
        xcodebuild test \
          -project ManusPsiqueia.xcodeproj \
          -scheme ${{ matrix.scheme }} \
          -destination '${{ matrix.destination }}' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          -enableCodeCoverage YES \
          | xcpretty --color --report html --output test-report.html
    
    - name: üìä Generate Code Coverage
      run: |
        xcrun xccov view --report --json DerivedData/*/Logs/Test/*.xcresult > coverage.json
        xcrun xccov view --report DerivedData/*/Logs/Test/*.xcresult
    
    - name: üì§ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.destination }}
        path: |
          test-report.html
          build-report.html
          coverage.json

  # ==========================================
  # üîí SECURITY SCANNING
  # ==========================================
  security-scan:
    name: üîí Security Scanning
    runs-on: macos-14
    needs: code-quality
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üîç Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: swift
        queries: security-and-quality
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üèóÔ∏è Build for CodeQL
      run: |
        xcodebuild clean build \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO
    
    - name: üîç Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:swift"
    
    - name: üõ°Ô∏è Run Additional Security Checks
      run: |
        echo "üîç Checking for security vulnerabilities..."
        
        # Verificar Info.plist por configura√ß√µes inseguras
        if [ -f "ManusPsiqueia/Info.plist" ]; then
          echo "üìã Analyzing Info.plist security..."
          plutil -lint ManusPsiqueia/Info.plist
          
          # Verificar se App Transport Security est√° configurado
          grep -q "NSAppTransportSecurity" ManusPsiqueia/Info.plist || echo "‚ö†Ô∏è ATS not configured"
        fi
        
        # Verificar certificados e chaves
        find . -name "*.p12" -o -name "*.mobileprovision" -o -name "*.cer" | while read file; do
          echo "üîë Found certificate/key file: $file"
        done

  # ==========================================
  # üì± UI TESTING
  # ==========================================
  ui-testing:
    name: üì± UI Testing
    runs-on: macos-14
    needs: build-and-test
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üöÄ Start iOS Simulator
      run: |
        xcrun simctl boot "${{ env.IOS_SIMULATOR }}" || true
        xcrun simctl list devices
    
    - name: üß™ Run UI Tests
      run: |
        xcodebuild test \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          -testPlan UITests \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty --color
      continue-on-error: true
    
    - name: üì∏ Capture Screenshots
      if: failure()
      run: |
        mkdir -p screenshots
        xcrun simctl io booted screenshot screenshots/failure-screenshot.png

  # ==========================================
  # üì¶ DEPENDENCY ANALYSIS
  # ==========================================
  dependency-analysis:
    name: üì¶ Dependency Analysis
    runs-on: macos-14
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîç Analyze Dependencies
      run: |
        echo "üì¶ Analyzing Swift Package Dependencies..."
        
        # Listar depend√™ncias do projeto
        if [ -f "Package.swift" ]; then
          echo "üìã Package.swift found, analyzing..."
          swift package show-dependencies --format json > dependencies.json
          cat dependencies.json
        fi
        
        # Verificar depend√™ncias no projeto Xcode
        if [ -f "ManusPsiqueia.xcodeproj/project.pbxproj" ]; then
          echo "üîç Analyzing Xcode project dependencies..."
          grep -o "https://github.com/[^\"]*" ManusPsiqueia.xcodeproj/project.pbxproj | sort | uniq
        fi
    
    - name: üõ°Ô∏è Security Audit
      run: |
        echo "üõ°Ô∏è Running security audit on dependencies..."
        
        # Verificar depend√™ncias conhecidas com vulnerabilidades
        echo "Checking for known vulnerable dependencies..."
        
        # Lista de depend√™ncias a evitar (exemplo)
        VULNERABLE_DEPS=("AFNetworking" "old-ssl-lib")
        
        for dep in "${VULNERABLE_DEPS[@]}"; do
          if grep -q "$dep" ManusPsiqueia.xcodeproj/project.pbxproj; then
            echo "‚ö†Ô∏è WARNING: Potentially vulnerable dependency found: $dep"
          fi
        done

  # ==========================================
  # üìä PERFORMANCE ANALYSIS
  # ==========================================
  performance-analysis:
    name: üìä Performance Analysis
    runs-on: macos-14
    needs: build-and-test
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üîç Analyze Code Metrics
      run: |
        echo "üìä Analyzing code metrics..."
        
        # Contar linhas de c√≥digo
        find . -name "*.swift" -not -path "./.git/*" | xargs wc -l | tail -1
        
        # Contar arquivos Swift
        find . -name "*.swift" -not -path "./.git/*" | wc -l
        
        # Verificar complexidade ciclom√°tica (aproximada)
        echo "üîÑ Checking cyclomatic complexity..."
        grep -r "if\|while\|for\|switch\|case\|catch\|&&\|||" --include="*.swift" . | wc -l
        
        # Verificar tamanho de arquivos grandes
        echo "üìè Checking large files..."
        find . -name "*.swift" -not -path "./.git/*" -exec wc -l {} + | sort -nr | head -10
    
    - name: üèóÔ∏è Build Size Analysis
      run: |
        echo "üì¶ Analyzing build size..."
        
        xcodebuild clean build \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO
        
        # Analisar tamanho do build
        find DerivedData -name "*.app" -exec du -sh {} \;

  # ==========================================
  # üìã GENERATE REPORTS
  # ==========================================
  generate-reports:
    name: üìã Generate Reports
    runs-on: macos-14
    needs: [code-quality, build-and-test, security-scan, dependency-analysis, performance-analysis]
    if: always()
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üì• Download All Artifacts
      uses: actions/download-artifact@v3
    
    - name: üìä Generate Comprehensive Report
      run: |
        echo "# üìä ManusPsiqueia - CI/CD Report" > ci-report.md
        echo "Generated on: $(date)" >> ci-report.md
        echo "" >> ci-report.md
        
        echo "## üîç Code Quality" >> ci-report.md
        if [ -f "swiftlint-results/swiftlint-results.json" ]; then
          echo "‚úÖ SwiftLint analysis completed" >> ci-report.md
        else
          echo "‚ùå SwiftLint analysis failed" >> ci-report.md
        fi
        echo "" >> ci-report.md
        
        echo "## üß™ Tests" >> ci-report.md
        echo "‚úÖ Unit tests executed" >> ci-report.md
        echo "‚úÖ UI tests executed" >> ci-report.md
        echo "" >> ci-report.md
        
        echo "## üîí Security" >> ci-report.md
        echo "‚úÖ CodeQL security analysis completed" >> ci-report.md
        echo "‚úÖ Dependency security audit completed" >> ci-report.md
        echo "" >> ci-report.md
        
        echo "## üì¶ Dependencies" >> ci-report.md
        echo "‚úÖ Dependency analysis completed" >> ci-report.md
        echo "" >> ci-report.md
        
        echo "## üìä Performance" >> ci-report.md
        echo "‚úÖ Code metrics analysis completed" >> ci-report.md
        echo "‚úÖ Build size analysis completed" >> ci-report.md
    
    - name: üì§ Upload Final Report
      uses: actions/upload-artifact@v3
      with:
        name: ci-cd-report
        path: ci-report.md
    
    - name: üí¨ Comment PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('ci-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ü§ñ CI/CD Pipeline Results\n\n${report}`
          });

  # ==========================================
  # üöÄ DEPLOYMENT (only on master)
  # ==========================================
  deploy:
    name: üöÄ Deploy to TestFlight
    runs-on: macos-14
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üçé Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: üîê Setup Production Secrets
      env:
        STRIPE_PUBLISHABLE_KEY_PRODUCTION: ${{ secrets.STRIPE_PUBLISHABLE_KEY_PRODUCTION }}
        STRIPE_SECRET_KEY_PRODUCTION: ${{ secrets.STRIPE_SECRET_KEY_PRODUCTION }}
        SUPABASE_URL_PRODUCTION: ${{ secrets.SUPABASE_URL_PRODUCTION }}
        SUPABASE_ANON_KEY_PRODUCTION: ${{ secrets.SUPABASE_ANON_KEY_PRODUCTION }}
        SUPABASE_SERVICE_ROLE_KEY_PRODUCTION: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PRODUCTION }}
        OPENAI_API_KEY_PRODUCTION: ${{ secrets.OPENAI_API_KEY_PRODUCTION }}
        DATABASE_URL_PRODUCTION: ${{ secrets.DATABASE_URL_PRODUCTION }}
        SMTP_HOST_PRODUCTION: ${{ secrets.SMTP_HOST_PRODUCTION }}
        SMTP_PORT_PRODUCTION: ${{ secrets.SMTP_PORT_PRODUCTION }}
        SMTP_USER_PRODUCTION: ${{ secrets.SMTP_USER_PRODUCTION }}
        SMTP_PASS_PRODUCTION: ${{ secrets.SMTP_PASS_PRODUCTION }}
        APNS_KEY_ID_PRODUCTION: ${{ secrets.APNS_KEY_ID_PRODUCTION }}
        APNS_TEAM_ID_PRODUCTION: ${{ secrets.APNS_TEAM_ID_PRODUCTION }}
        MIXPANEL_TOKEN_PRODUCTION: ${{ secrets.MIXPANEL_TOKEN_PRODUCTION }}
      run: |
        echo "üîê Setting up production secrets for deployment..."
        
        # Create production secrets file
        mkdir -p Configuration/Secrets
        ./scripts/secrets_manager.sh setup
        
        cat > Configuration/Secrets/production.secrets << EOF
        # Production Secrets - Auto-generated for CI/CD
        STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY_PRODUCTION
        STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY_PRODUCTION
        SUPABASE_URL=$SUPABASE_URL_PRODUCTION
        SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY_PRODUCTION
        SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY_PRODUCTION
        OPENAI_API_KEY=$OPENAI_API_KEY_PRODUCTION
        DATABASE_URL=$DATABASE_URL_PRODUCTION
        SMTP_HOST=$SMTP_HOST_PRODUCTION
        SMTP_PORT=$SMTP_PORT_PRODUCTION
        SMTP_USER=$SMTP_USER_PRODUCTION
        SMTP_PASS=$SMTP_PASS_PRODUCTION
        APNS_KEY_ID=$APNS_KEY_ID_PRODUCTION
        APNS_TEAM_ID=$APNS_TEAM_ID_PRODUCTION
        APNS_BUNDLE_ID=com.ailun.manuspsiqueia
        FIREBASE_CONFIG_FILE=GoogleService-Info.plist
        MIXPANEL_TOKEN=$MIXPANEL_TOKEN_PRODUCTION
        EOF
        
        # Validate secrets
        ./scripts/secrets_manager.sh validate --env production
    
    - name: üîë Setup Certificates
      env:
        CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
        CERTIFICATES_PASSWORD: ${{ secrets.CERTIFICATES_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        echo "üîë Setting up certificates and provisioning profiles..."
        
        # Create certificate directory
        mkdir -p ~/.certificates
        
        # Decode and install certificates
        if [ ! -z "$CERTIFICATES_P12" ]; then
          echo "$CERTIFICATES_P12" | base64 --decode > ~/.certificates/cert.p12
          
          # Create temporary keychain
          security create-keychain -p "temp123" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "temp123" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          security import ~/.certificates/cert.p12 -k build.keychain -P "$CERTIFICATES_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "temp123" build.keychain
          
          echo "‚úÖ Certificates installed"
        else
          echo "‚ö†Ô∏è No certificates provided, using automatic signing"
        fi
        
        # Install provisioning profile
        if [ ! -z "$PROVISIONING_PROFILE" ]; then
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision
          echo "‚úÖ Provisioning profile installed"
        fi
    
    - name: üèóÔ∏è Build for Release
      run: |
        echo "üèóÔ∏è Building for release with production configuration..."
        
        xcodebuild clean archive \
          -project ManusPsiqueia.xcodeproj \
          -scheme ManusPsiqueia \
          -destination 'generic/platform=iOS' \
          -configuration Production \
          -archivePath ManusPsiqueia.xcarchive \
          -allowProvisioningUpdates \
          DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
          | xcpretty --color
    
    - name: üì¶ Export IPA
      run: |
        echo "üì¶ Exporting IPA for App Store distribution..."
        
        # Create export options plist
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.DEVELOPMENT_TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath ManusPsiqueia.xcarchive \
          -exportPath . \
          -exportOptionsPlist ExportOptions.plist \
          | xcpretty --color
    
    - name: üöÄ Upload to TestFlight
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      run: |
        echo "üöÄ Uploading to TestFlight..."
        
        if [ ! -z "$APP_STORE_CONNECT_API_KEY" ]; then
          # Setup API key
          mkdir -p ~/.appstoreconnect/private_keys/
          echo "$APP_STORE_CONNECT_API_KEY" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
          
          # Upload using altool (requires Xcode command line tools)
          xcrun altool --upload-app \
            --type ios \
            --file "ManusPsiqueia.ipa" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"
          
          echo "‚úÖ Upload to TestFlight completed"
        else
          echo "‚ö†Ô∏è App Store Connect API key not configured, skipping upload"
          echo "IPA file created: ManusPsiqueia.ipa"
        fi
    
    - name: üßπ Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up sensitive files..."
        
        # Remove secrets file
        rm -f Configuration/Secrets/production.secrets
        
        # Remove certificates and keys
        rm -rf ~/.certificates
        rm -rf ~/.appstoreconnect
        
        # Delete temporary keychain
        security delete-keychain build.keychain || true
        
        echo "‚úÖ Cleanup completed"
    
    - name: üì§ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: production-build-${{ github.run_number }}
        path: |
          ManusPsiqueia.ipa
          ManusPsiqueia.xcarchive
        retention-days: 7

# ==========================================
# üìß NOTIFICATIONS
# ==========================================
  notify:
    name: üìß Notify Results
    runs-on: ubuntu-latest
    needs: [generate-reports]
    if: always()
    
    steps:
    - name: üìß Send Notification
      run: |
        echo "üìß Sending notification about CI/CD results..."
        echo "Pipeline completed for commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Status: ${{ job.status }}"
